# 衣服照片处理脚本详解

## 脚本整体流程图

```
输入图片 → 背景透明化 → AI智能分类 → 输出结果
  (photo/)    (U²-Net)    (通义千问)   (output/)
```

---

## 第一部分：导入依赖库

```python
import os
import base64
import json
from pathlib import Path
from PIL import Image
from rembg import remove
import requests
```

| 库 | 用途 |
|----|------|
| `os` | 操作系统相关功能 |
| `base64` | 图片转Base64编码（用于API传输） |
| `json` | 处理JSON数据格式 |
| `pathlib.Path` | 更优雅的文件路径处理 |
| `PIL.Image` | 图像处理库 |
| `rembg` | 背景去除库（内置U²-Net模型） |
| `requests` | 发送HTTP请求调用API |

---

## 第二部分：配置参数

```python
# 文件夹路径配置
PHOTO_DIR = Path("photo")           # 输入图片文件夹
OUTPUT_DIR = Path("output")         # 输出文件夹
TRANSPARENT_DIR = OUTPUT_DIR / "transparent"  # 透明图片子文件夹

# 阿里云通义千问API配置
DASHSCOPE_API_KEY = "sk-..."        # API密钥（身份验证）
DASHSCOPE_BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"
```

---

## 第三部分：背景透明化函数

```python
def remove_background(input_path, output_path):
    """使用rembg去除图片背景 (U²-Net模型)"""
    # 1. 读取原始图片（二进制模式）
    with open(input_path, 'rb') as f:
        input_image = f.read()
    
    # 2. 调用rembg的remove函数（自动使用U²-Net模型）
    output_image = remove(input_image)
    
    # 3. 保存透明背景图片（PNG格式支持透明通道）
    with open(output_path, 'wb') as f:
        f.write(output_image)
```

### U²-Net模型简介
- **全称**：U-square-Net
- **功能**：显著性目标检测（Salient Object Detection）
- **原理**：深度学习卷积神经网络，自动识别图片中的主体（衣服）和背景
- **输出**：Alpha通道蒙版，将背景变为透明

---

## 第四部分：图片转Base64

```python
def encode_image_to_base64(image_path):
    """将图片转换为base64编码"""
    with open(image_path, 'rb') as f:
        return base64.b64encode(f.read()).decode('utf-8')
```

### 为什么要转Base64？
- API传输需要文本格式
- Base64可以将二进制图片转为ASCII字符串
- 直接嵌入到JSON请求体中

---

## 第五部分：AI分类（核心功能）

```python
def classify_with_qwen(image_path):
    """使用阿里云通义千问进行图像识别"""
    
    # 1. 图片转Base64
    base64_image = encode_image_to_base64(image_path)
    
    # 2. 设置请求头（包含API密钥）
    headers = {
        "Authorization": f"Bearer {DASHSCOPE_API_KEY}",
        "Content-Type": "application/json"
    }
    
    # 3. 构建请求体
    payload = {
        "model": "qwen-vl-max",  # 视觉语言大模型
        "messages": [
            {
                "role": "system",
                "content": "你是一个专业的服装识别专家..."
            },
            {
                "role": "user",
                "content": [
                    {
                        "type": "image_url",  # 发送图片
                        "image_url": {
                            "url": f"data:image/jpeg;base64,{base64_image}"
                        }
                    },
                    {
                        "type": "text",  # 发送提示词
                        "text": "请分析这张服装图片..."
                    }
                ]
            }
        ]
    }
    
    # 4. 发送POST请求
    response = requests.post(
        f"{DASHSCOPE_BASE_URL}/chat/completions",
        headers=headers,
        json=payload,
        timeout=60
    )
    
    # 5. 解析返回结果
    result = response.json()
    content = result["choices"][0]["message"]["content"]
```

### 通义千问API工作原理

```
┌─────────────┐     HTTP POST      ┌──────────────┐
│  本地脚本    │ ───────────────→  │ 阿里云服务器  │
│             │   图片+提示词       │  通义千问模型 │
└─────────────┘                   └──────────────┘
       ↑                                  │
       └────────── JSON结果 ←─────────────┘
                    分类信息
```

### 提示词（Prompt）设计

```python
"请详细分析这张服装图片，并按以下JSON格式返回结果：
{
    \"category\": \"服装类别\",
    \"type\": \"具体类型\",
    \"color\": \"主要颜色\",
    \"style\": \"风格\",
    \"material\": \"材质\",
    \"features\": [\"特征1\", \"特征2\"],
    \"description\": \"详细描述\",
    \"confidence\": \"置信度\"
}"
```

**作用**：引导AI按指定格式输出结构化数据

---

## 第六部分：主处理流程

```python
def process_all_images():
    """处理所有图片"""
    
    # 1. 扫描所有图片文件
    image_extensions = {'.jpg', '.jpeg', '.png', '.webp', '.bmp'}
    image_files = [f for f in PHOTO_DIR.iterdir() 
                   if f.is_file() and f.suffix.lower() in image_extensions]
    
    # 2. 遍历处理每张图片
    for image_file in image_files:
        
        # 步骤1: 背景透明化
        transparent_path = TRANSPARENT_DIR / f"{image_file.stem}_transparent.png"
        remove_background(image_file, transparent_path)
        
        # 步骤2: AI分类
        classification = classify_with_qwen(image_file)
        
        # 步骤3: 保存结果
        results.append(classification)
    
    # 3. 导出JSON文件
    with open(results_path, 'w', encoding='utf-8') as f:
        json.dump(results, f, ensure_ascii=False, indent=2)
```

---

## 技术架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                      用户层                                  │
│              python process_clothes.py                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    本地处理层                                │
│  ┌──────────────┐          ┌──────────────┐                │
│  │  文件扫描     │          │ 图片读取      │                │
│  │ (pathlib)    │          │ (PIL/rembg)  │                │
│  └──────────────┘          └──────────────┘                │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐      ┌───────────────────────────┐
│    U²-Net 本地模型       │      │   通义千问API (云端)       │
│   (背景透明化)           │      │   (智能分类)              │
│                         │      │                           │
│  • 深度学习模型          │      │  • 视觉理解               │
│  • 显著性检测            │      │  • 自然语言生成            │
│  • 本地运行              │      │  • 云端服务                │
└─────────────────────────┘      └───────────────────────────┘
              │                               │
              └───────────────┬───────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    输出层                                    │
│  ┌──────────────────┐    ┌──────────────────┐              │
│  │ transparent/     │    │ classification_  │              │
│  │   *.png          │    │ results.json     │              │
│  │   (透明图片)      │    │   (分类数据)      │              │
│  └──────────────────┘    └──────────────────┘              │
└─────────────────────────────────────────────────────────────┘
```

---

## 关键技术点总结

| 技术 | 用途 | 位置 |
|------|------|------|
| **U²-Net** | 背景去除/透明化 | 本地（rembg库） |
| **Base64编码** | 图片转文本传输 | 本地预处理 |
| **通义千问VL** | 视觉理解/分类 | 阿里云API |
| **JSON格式化** | 结构化数据存储 | 本地输出 |

---

## 如何运行

```bash
# 1. 安装依赖
pip install rembg pillow requests

# 2. 将衣服照片放入 photo/ 文件夹

# 3. 运行脚本
python process_clothes.py

# 4. 查看结果
# - 透明图片: output/transparent/
# - 分类数据: output/classification_results.json
```
